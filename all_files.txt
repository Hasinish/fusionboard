
===== FILE: all_files.txt =====


===== FILE: backend\.env =====
MONGO_URI=mongodb+srv://hasinishrak2015_db_user:MUb26jLpTSng8XtW@cluster0.qgo2q3t.mongodb.net/fusionboard_db?appName=Cluster0
PORT=5001
JWT_SECRET=abc123

===== FILE: backend\.gitignore =====
# Node modules
node_modules/


# Logs
npm-debug.log*
yarn-debug.log*
pnpm-debug.log*

# OS files
.DS_Store

.env

===== FILE: backend\package.json =====
{
  "name": "backend",
  "version": "1.0.0",
  "description": "",
  "main": "src/server.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "dev": "nodemon src/server.js",
    "start": "node src/server.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "type": "module",
  "dependencies": {
    "bcryptjs": "^3.0.3",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^4.18.2",
    "jsonwebtoken": "^9.0.3",
    "mongoose": "^8.14.3"
  },
  "devDependencies": {
    "nodemon": "^3.1.11"
  }
}


===== FILE: backend\src\server.js =====
import express from "express";
import cors from "cors";
import dotenv from "dotenv";

import authRoutes from "./routes/authRoutes.js";
import workspaceRoutes from "./routes/workspaceRoutes.js";
import invitationRoutes from "./routes/invitationRoutes.js";
import { connectDB } from "./config/db.js";

dotenv.config();

const app = express();
const PORT = process.env.PORT || 5001;
connectDB();

// middleware
app.use(
  cors({
    origin: "http://localhost:5173",
  })
);
app.use(express.json());

// routes
app.use("/api/auth", authRoutes);
app.use("/api/workspaces", workspaceRoutes);
app.use("/api/invitations", invitationRoutes);

// start server
app.listen(PORT, () => {
  console.log("Server started on PORT:", PORT);
});


===== FILE: backend\src\config\db.js =====
import mongoose from "mongoose";

export const connectDB = async () => {
    try {
        await mongoose.connect(process.env.MONGO_URI);
        
        console.log("MONGODB CONNECTED SUCCESSFULLY!");
    } catch (error) {
        console.error("Error connecting to MONGODB", error);
        process.exit(1); 
    }
};

===== FILE: backend\src\controllers\authController.js =====
import User from "../models/User.js";
import bcrypt from "bcryptjs";
import jwt from "jsonwebtoken";

export async function register(req, res) {
  try {
    const { name, email, password } = req.body;

    // Check existing user
    const exists = await User.findOne({ email });
    if (exists) return res.status(400).json({ message: "Email already used" });

    // Hash password
    const hashed = await bcrypt.hash(password, 10);

    await User.create({ name, email, password: hashed });

    res.json({ message: "Registered successfully" });
  } catch (e) {
    res.status(500).json({ message: "Server error" });
  }
}

export async function login(req, res) {
  try {
    const { email, password } = req.body;

    const user = await User.findOne({ email });
    if (!user) return res.status(400).json({ message: "Invalid credentials" });

    const match = await bcrypt.compare(password, user.password);
    if (!match) return res.status(400).json({ message: "Invalid credentials" });

    // Create token
    const token = jwt.sign({ id: user._id }, process.env.JWT_SECRET);

    // Send token + basic user info
    res.json({
      token,
      user: {
        id: user._id,
        name: user.name,
        email: user.email,
      },
    });
  } catch (e) {
    res.status(500).json({ message: "Server error" });
  }
}

// UPDATE LOGGED-IN USER PROFILE
export async function updateMe(req, res) {
  try {
    const userId = req.userId;
    const { name, email } = req.body;

    const user = await User.findById(userId);
    if (!user) return res.status(404).json({ message: "User not found" });

    // If email is changed, check uniqueness
    if (email && email !== user.email) {
      const exists = await User.findOne({ email });
      if (exists) {
        return res.status(400).json({ message: "Email already used" });
      }
      user.email = email;
    }

    if (name) {
      user.name = name;
    }

    await user.save();

    return res.json({
      message: "Profile updated successfully",
      user: {
        id: user._id,
        name: user.name,
        email: user.email,
      },
    });
  } catch (e) {
    return res.status(500).json({ message: "Server error" });
  }
}


===== FILE: backend\src\controllers\invitationController.js =====
import Invitation from "../models/Invitation.js";
import Workspace from "../models/Workspace.js";

// Get pending invitations for logged-in user
export async function getMyInvitations(req, res) {
  try {
    const userId = req.userId;

    const invitations = await Invitation.find({
      invitedUser: userId,
      status: "pending",
    })
      .sort({ createdAt: -1 })
      .populate("workspace", "name")
      .populate("invitedBy", "name email")
      .lean();

    return res.json(invitations);
  } catch (e) {
    console.error("Error fetching invitations:", e);
    return res.status(500).json({ message: "Server error" });
  }
}

export async function acceptInvitation(req, res) {
  try {
    const userId = req.userId;
    const { id } = req.params;

    const invitation = await Invitation.findOne({
      _id: id,
      invitedUser: userId,
    });

    if (!invitation) {
      return res.status(404).json({ message: "Invitation not found" });
    }

    if (invitation.status !== "pending") {
      return res.status(400).json({ message: "Invitation already processed" });
    }

    invitation.status = "accepted";
    await invitation.save();

    const workspace = await Workspace.findById(invitation.workspace);
    if (!workspace) {
      return res.status(404).json({ message: "Workspace not found" });
    }

    const alreadyMember = workspace.members.some(
      (m) => String(m.user) === String(userId)
    );
    if (!alreadyMember) {
      // Default role for new members is viewer
      workspace.members.push({ user: userId, role: "viewer" });
      await workspace.save();
    }

    return res.json({ message: "Invitation accepted" });
  } catch (e) {
    console.error("Error accepting invitation:", e);
    return res.status(500).json({ message: "Server error" });
  }
}

export async function rejectInvitation(req, res) {
  try {
    const userId = req.userId;
    const { id } = req.params;

    const invitation = await Invitation.findOne({
      _id: id,
      invitedUser: userId,
    });

    if (!invitation) {
      return res.status(404).json({ message: "Invitation not found" });
    }

    if (invitation.status !== "pending") {
      return res.status(400).json({ message: "Invitation already processed" });
    }

    invitation.status = "rejected";
    await invitation.save();

    return res.json({ message: "Invitation rejected" });
  } catch (e) {
    console.error("Error rejecting invitation:", e);
    return res.status(500).json({ message: "Server error" });
  }
}



===== FILE: backend\src\controllers\workspaceController.js =====
// backend/src/controllers/workspaceController.js
import Workspace from "../models/Workspace.js";
import User from "../models/User.js";
import Invitation from "../models/Invitation.js";

const ONLINE_THRESHOLD_MS = 1000 * 60 * 5; // 5 minutes

// Create a new workspace and send invitations
export async function createWorkspace(req, res) {
  try {
    const userId = req.userId;
    const { name, description, memberEmails } = req.body;

    if (!name) {
      return res.status(400).json({ message: "Workspace name is required" });
    }

    const owner = await User.findById(userId);
    if (!owner) {
      return res.status(404).json({ message: "Owner user not found" });
    }

    // Create workspace with owner as first member (role: owner)
    const workspace = await Workspace.create({
      name,
      description: description || "",
      owner: owner._id,
      members: [
        {
          user: owner._id,
          role: "owner",
        },
      ],
    });

    // memberEmails is expected as an array of strings
    if (Array.isArray(memberEmails)) {
      for (const rawEmail of memberEmails) {
        const email = String(rawEmail).trim().toLowerCase();
        if (!email) continue;
        if (email === owner.email.toLowerCase()) continue; // skip self

        const invitedUser = await User.findOne({ email });
        if (!invitedUser) {
          // If user not registered, skip silently for now
          continue;
        }

        // Avoid duplicate invitation
        const existingInvite = await Invitation.findOne({
          workspace: workspace._id,
          invitedUser: invitedUser._id,
          status: "pending",
        });

        if (!existingInvite) {
          await Invitation.create({
            workspace: workspace._id,
            invitedBy: owner._id,
            invitedUser: invitedUser._id,
          });
        }
      }
    }

    return res.status(201).json({
      message: "Workspace created successfully",
      workspace,
    });
  } catch (e) {
    console.error("Error creating workspace:", e);
    return res.status(500).json({ message: "Server error" });
  }
}

// Invite new members (by email) from an existing workspace (owner only)
export async function inviteMembers(req, res) {
  try {
    const userId = req.userId;
    const { id } = req.params;
    const { memberEmails } = req.body;

    if (!Array.isArray(memberEmails) || memberEmails.length === 0) {
      return res.status(400).json({ message: "No emails provided" });
    }

    const workspace = await Workspace.findById(id)
      .populate("owner", "email")
      .populate("members.user", "email");

    if (!workspace) {
      return res.status(404).json({ message: "Workspace not found" });
    }

    if (String(workspace.owner._id) !== String(userId)) {
      return res.status(403).json({ message: "Only owner can invite members" });
    }

    const ownerEmail = workspace.owner.email.toLowerCase();

    for (const rawEmail of memberEmails) {
      const email = String(rawEmail).trim().toLowerCase();
      if (!email) continue;
      if (email === ownerEmail) continue;

      const invitedUser = await User.findOne({ email });
      if (!invitedUser) {
        continue;
      }

      const alreadyMember = workspace.members.some(
        (m) =>
          String(m.user._id || m.user) === String(invitedUser._id)
      );
      if (alreadyMember) continue;

      const existingInvite = await Invitation.findOne({
        workspace: workspace._id,
        invitedUser: invitedUser._id,
        status: "pending",
      });
      if (existingInvite) continue;

      await Invitation.create({
        workspace: workspace._id,
        invitedBy: workspace.owner._id,
        invitedUser: invitedUser._id,
      });
    }

    return res.json({ message: "Invitations sent (for registered users)." });
  } catch (e) {
    console.error("Error inviting members:", e);
    return res.status(500).json({ message: "Server error" });
  }
}

// Get all workspaces where the user is a member
export async function getMyWorkspaces(req, res) {
  try {
    const userId = req.userId;

    const workspaces = await Workspace.find({
      "members.user": userId,
    })
      .sort({ createdAt: -1 })
      .lean();

    return res.json(workspaces);
  } catch (e) {
    console.error("Error fetching workspaces:", e);
    return res.status(500).json({ message: "Server error" });
  }
}

// Get details of a single workspace (only if user is member/owner)
export async function getWorkspaceById(req, res) {
  try {
    const userId = req.userId;
    const { id } = req.params;

    const workspace = await Workspace.findById(id)
      .populate("owner", "name email lastActive")
      .populate("members.user", "name email lastActive")
      .lean();

    if (!workspace) {
      return res.status(404).json({ message: "Workspace not found" });
    }

    const isMember = (workspace.members || []).some(
      (m) => String(m.user?._id || m.user) === String(userId)
    );

    if (!isMember) {
      return res
        .status(403)
        .json({ message: "Not allowed to view workspace" });
    }

    const now = Date.now();

    let ownerData = null;
    if (workspace.owner) {
      const lastActive = workspace.owner.lastActive
        ? new Date(workspace.owner.lastActive).getTime()
        : 0;
      const isOnline =
        lastActive > 0 && now - lastActive < ONLINE_THRESHOLD_MS;

      ownerData = {
        _id: workspace.owner._id,
        name: workspace.owner.name,
        email: workspace.owner.email,
        isOnline,
      };
    }

    const members = (workspace.members || [])
      .map((m) => {
        const u = m.user;
        if (!u) return null;
        const lastActive = u.lastActive
          ? new Date(u.lastActive).getTime()
          : 0;
        const isOnline =
          lastActive > 0 && now - lastActive < ONLINE_THRESHOLD_MS;

        return {
          _id: u._id,
          name: u.name,
          email: u.email,
          role: m.role,
          isOnline,
        };
      })
      .filter(Boolean);

    return res.json({
      _id: workspace._id,
      name: workspace.name,
      description: workspace.description,
      owner: ownerData,
      members,
    });
  } catch (e) {
    console.error("Error fetching workspace:", e);
    return res.status(500).json({ message: "Server error" });
  }
}

// Change a member's role (owner, editor, viewer) – only owner can do this
export async function updateMemberRole(req, res) {
  try {
    const userId = req.userId;
    const { id, memberId } = req.params;
    const { role } = req.body;

    const allowedRoles = ["owner", "editor", "viewer"];
    if (!allowedRoles.includes(role)) {
      return res.status(400).json({ message: "Invalid role" });
    }

    const workspace = await Workspace.findById(id).populate("owner", "_id");
    if (!workspace) {
      return res.status(404).json({ message: "Workspace not found" });
    }

    if (String(workspace.owner._id) !== String(userId)) {
      return res
        .status(403)
        .json({ message: "Only owner can change member roles" });
    }

    const member = workspace.members.find(
      (m) => String(m.user) === String(memberId)
    );
    if (!member) {
      return res.status(404).json({ message: "Member not found in workspace" });
    }

    // Do not allow owner to make themselves non-owner using this endpoint
    if (
      String(workspace.owner._id) === String(memberId) &&
      role !== "owner"
    ) {
      return res.status(400).json({
        message:
          "To change owner, assign role 'owner' to another member first.",
      });
    }

    if (role === "owner") {
      // Transfer ownership: new owner gets owner role, old owner becomes editor
      workspace.members.forEach((m) => {
        if (String(m.user) === String(memberId)) {
          m.role = "owner";
        } else if (m.role === "owner") {
          m.role = "editor"; // demote previous owner
        }
      });
      workspace.owner = member.user;
    } else {
      member.role = role;
    }

    await workspace.save();

    return res.json({ message: "Member role updated" });
  } catch (e) {
    console.error("Error updating member role:", e);
    return res.status(500).json({ message: "Server error" });
  }
}

// Remove a member from workspace – only owner, cannot remove owner
export async function removeMember(req, res) {
  try {
    const userId = req.userId;
    const { id, memberId } = req.params;

    const workspace = await Workspace.findById(id).populate("owner", "_id");
    if (!workspace) {
      return res.status(404).json({ message: "Workspace not found" });
    }

    if (String(workspace.owner._id) !== String(userId)) {
      return res
        .status(403)
        .json({ message: "Only owner can remove members" });
    }

    if (String(workspace.owner._id) === String(memberId)) {
      return res
        .status(400)
        .json({ message: "Owner cannot be removed from the workspace" });
    }

    const beforeCount = workspace.members.length;
    workspace.members = workspace.members.filter(
      (m) => String(m.user) !== String(memberId)
    );

    if (workspace.members.length === beforeCount) {
      return res
        .status(404)
        .json({ message: "Member not found in workspace" });
    }

    await workspace.save();

    return res.json({ message: "Member removed from workspace" });
  } catch (e) {
    console.error("Error removing member:", e);
    return res.status(500).json({ message: "Server error" });
  }
}


===== FILE: backend\src\middleware\authMiddleware.js =====
import jwt from "jsonwebtoken";
import User from "../models/User.js";

export function authMiddleware(req, res, next) {
  const authHeader = req.headers.authorization;

  if (!authHeader) {
    return res.status(401).json({ message: "No token provided" });
  }

  const parts = authHeader.split(" ");
  if (parts.length !== 2 || parts[0] !== "Bearer") {
    return res.status(401).json({ message: "Invalid authorization format" });
  }

  const token = parts[1];

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.userId = decoded.id;

    // Update lastActive (fire and forget)
    User.findByIdAndUpdate(decoded.id, { lastActive: new Date() }).catch(
      () => {}
    );

    next();
  } catch (err) {
    return res.status(401).json({ message: "Invalid or expired token" });
  }
}


===== FILE: backend\src\models\Invitation.js =====
// backend/src/models/Invitation.js
import mongoose from "mongoose";

const invitationSchema = new mongoose.Schema(
  {
    workspace: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Workspace",
      required: true,
    },
    invitedBy: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true,
    },
    invitedUser: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true,
    },
    status: {
      type: String,
      enum: ["pending", "accepted", "rejected"],
      default: "pending",
    },
  },
  { timestamps: true }
);

export default mongoose.model("Invitation", invitationSchema);


===== FILE: backend\src\models\User.js =====
import mongoose from "mongoose";

const userSchema = new mongoose.Schema({
  name: { type: String, required: true },
  email: { type: String, required: true, unique: true },
  password: { type: String, required: true }, // hashed password
  lastActive: { type: Date, default: null },  // for online/offline status
});

export default mongoose.model("User", userSchema);


===== FILE: backend\src\models\Workspace.js =====
// backend/src/models/Workspace.js
import mongoose from "mongoose";

const memberSchema = new mongoose.Schema(
  {
    user: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true,
    },
    role: {
      type: String,
      enum: ["owner", "editor", "viewer"],
      default: "viewer",
    },
  },
  { _id: false }
);

const workspaceSchema = new mongoose.Schema(
  {
    name: { type: String, required: true },
    description: { type: String },

    // Current owner (there can be only one)
    owner: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true,
    },

    // Members (including owner) with roles
    members: [memberSchema],
  },
  { timestamps: true }
);

export default mongoose.model("Workspace", workspaceSchema);


===== FILE: backend\src\routes\authRoutes.js =====
import express from "express";
import { register, login, updateMe } from "../controllers/authController.js";
import { authMiddleware } from "../middleware/authMiddleware.js";

const router = express.Router();

router.post("/register", register);
router.post("/login", login);


router.put("/me", authMiddleware, updateMe);

export default router;


===== FILE: backend\src\routes\invitationRoutes.js =====
// backend/src/routes/invitationRoutes.js
import express from "express";
import { authMiddleware } from "../middleware/authMiddleware.js";
import {
  getMyInvitations,
  acceptInvitation,
  rejectInvitation,
} from "../controllers/invitationController.js";

const router = express.Router();

// GET /api/invitations/my
router.get("/my", authMiddleware, getMyInvitations);

// POST /api/invitations/:id/accept
router.post("/:id/accept", authMiddleware, acceptInvitation);

// POST /api/invitations/:id/reject
router.post("/:id/reject", authMiddleware, rejectInvitation);

export default router;


===== FILE: backend\src\routes\workspaceRoutes.js =====
// backend/src/routes/workspaceRoutes.js
import express from "express";
import { authMiddleware } from "../middleware/authMiddleware.js";
import {
  createWorkspace,
  getMyWorkspaces,
  getWorkspaceById,
  inviteMembers,
  updateMemberRole,
  removeMember,
} from "../controllers/workspaceController.js";

const router = express.Router();

// POST /api/workspaces
router.post("/", authMiddleware, createWorkspace);

// POST /api/workspaces/:id/invite
router.post("/:id/invite", authMiddleware, inviteMembers);

// GET /api/workspaces/my
router.get("/my", authMiddleware, getMyWorkspaces);

// GET /api/workspaces/:id
router.get("/:id", authMiddleware, getWorkspaceById);

// PATCH /api/workspaces/:id/members/:memberId/role
router.patch(
  "/:id/members/:memberId/role",
  authMiddleware,
  updateMemberRole
);

// DELETE /api/workspaces/:id/members/:memberId
router.delete("/:id/members/:memberId", authMiddleware, removeMember);

export default router;


===== FILE: frontend\.gitignore =====
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
pnpm-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?



===== FILE: frontend\eslint.config.js =====
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])


===== FILE: frontend\index.html =====
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>frontend</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>


===== FILE: frontend\package.json =====
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "axios": "^1.13.2",
    "lucide-react": "^0.556.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router": "^7.10.1",
    "react-router-dom": "^7.10.1"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.22",
    "daisyui": "^4.12.24",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.18",
    "vite": "^7.2.4"
  }
}


===== FILE: frontend\postcss.config.js =====
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}


===== FILE: frontend\README.md =====
# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend using TypeScript with type-aware lint rules enabled. Check out the [TS template](https://github.com/vitejs/vite/tree/main/packages/create-vite/template-react-ts) for information on how to integrate TypeScript and [`typescript-eslint`](https://typescript-eslint.io) in your project.


===== FILE: frontend\tailwind.config.js =====
import daisyui from 'daisyui';

/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [daisyui],
}

===== FILE: frontend\vite.config.js =====
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})


===== IMAGE FILE: frontend\public\vite.svg =====

===== FILE: frontend\src\App.jsx =====
import { Routes, Route } from "react-router-dom";
import LoginPage from "./pages/LoginPage";
import RegisterPage from "./pages/RegisterPage";
import DashboardPage from "./pages/DashboardPage";
import ProfilePage from "./pages/ProfilePage";
import CreateWorkspacePage from "./pages/CreateWorkspacePage";
import WorkspaceDetailsPage from "./pages/WorkspaceDetailsPage";
import NotificationsPage from "./pages/NotificationsPage";

function App() {
  return (
    <div className="min-h-screen bg-base-200">
      <Routes>
        <Route path="/" element={<LoginPage />} />
        <Route path="/login" element={<LoginPage />} />
        <Route path="/register" element={<RegisterPage />} />
        <Route path="/dashboard" element={<DashboardPage />} />
        <Route path="/profile" element={<ProfilePage />} />
        <Route path="/workspaces/create" element={<CreateWorkspacePage />} />
        <Route path="/workspaces/:id" element={<WorkspaceDetailsPage />} />
        <Route path="/notifications" element={<NotificationsPage />} />
      </Routes>
    </div>
  );
}

export default App;


===== FILE: frontend\src\index.css =====
@tailwind base;
@tailwind components;
@tailwind utilities;



===== FILE: frontend\src\main.jsx =====
import { StrictMode } from "react";
import { createRoot } from "react-dom/client";
import "./index.css";
import App from "./App.jsx";
import { BrowserRouter } from "react-router-dom";

createRoot(document.getElementById("root")).render(
  <StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </StrictMode>
);


===== FILE: frontend\src\components\NavBar.jsx =====
// frontend/src/components/NavBar.jsx
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { getUser, isLoggedIn } from "../lib/auth";
import api from "../lib/api";

function NavBar() {
  const user = getUser();
  const initial = user?.name?.[0]?.toUpperCase() || "U";
  const navigate = useNavigate();

  const [pendingCount, setPendingCount] = useState(0);

  useEffect(() => {
    const fetchInvites = async () => {
      if (!isLoggedIn()) return;
      const token = localStorage.getItem("token");
      if (!token) return;

      try {
        const res = await api.get("/invitations/my", {
          headers: { Authorization: `Bearer ${token}` },
        });
        setPendingCount(Array.isArray(res.data) ? res.data.length : 0);
      } catch {
        // keep silent for navbar
      }
    };

    fetchInvites();
  }, []);

  return (
    <div className="navbar bg-base-100 shadow-sm">
      <div className="max-w-6xl mx-auto flex w-full items-center justify-between px-4">
        {/* Left: Logo / Name */}
        <div className="flex items-center gap-2">
          <span
            className="text-xl font-bold tracking-tight cursor-pointer"
            onClick={() => navigate("/dashboard")}
          >
            Fusion<span className="text-primary">Board</span>
          </span>
        </div>

        {/* Right: Create workspace + notifications + profile icon */}
        <div className="flex items-center gap-4">
          <button
            className="btn btn-ghost btn-sm"
            onClick={() => navigate("/notifications")}
          >
            Notifications
            {pendingCount > 0 && (
              <span className="badge badge-secondary ml-1">
                {pendingCount}
              </span>
            )}
          </button>

          <button
            className="btn btn-primary btn-sm"
            onClick={() => navigate("/workspaces/create")}
          >
            Create workspace
          </button>

          {/* Round human icon (avatar placeholder) */}
          <div
            className="avatar cursor-pointer"
            onClick={() => navigate("/profile")}
            title="Profile"
          >
            <div className="w-10 rounded-full bg-neutral text-neutral-content flex items-center justify-center">
              <span className="text-lg font-semibold">{initial}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default NavBar;


===== FILE: frontend\src\lib\api.js =====
import axios from "axios";

export default axios.create({
  baseURL: "http://localhost:5001/api"
});


===== FILE: frontend\src\lib\auth.js =====
// Save token + user info
export function saveAuth(token, user) {
  localStorage.setItem("token", token);
  localStorage.setItem("user", JSON.stringify(user));
}

// Get current user object or null
export function getUser() {
  const raw = localStorage.getItem("user");
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
}

// Simple logged-in check
export function isLoggedIn() {
  return !!localStorage.getItem("token");
}

// Clear auth on logout
export function clearAuth() {
  localStorage.removeItem("token");
  localStorage.removeItem("user");
}


===== FILE: frontend\src\pages\CreateWorkspacePage.jsx =====
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import NavBar from "../components/NavBar";
import api from "../lib/api";
import { isLoggedIn } from "../lib/auth";

function CreateWorkspacePage() {
  const navigate = useNavigate();

  const [name, setName] = useState("");
  const [description, setDescription] = useState("");
  const [memberEmailsText, setMemberEmailsText] = useState("");
  const [error, setError] = useState("");
  const [message, setMessage] = useState("");
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (!isLoggedIn()) {
      navigate("/login");
    }
  }, [navigate]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError("");
    setMessage("");

    const token = localStorage.getItem("token");
    if (!token) {
      setError("Not authenticated.");
      return;
    }

    const memberEmails = memberEmailsText
      .split(",")
      .map((e) => e.trim())
      .filter((e) => e.length > 0);

    setLoading(true);
    try {
      await api.post(
        "/workspaces",
        { name, description, memberEmails },
        {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );

      setMessage(
        "Workspace created and invitations sent to registered users (by email)."
      );
      setTimeout(() => {
        navigate("/dashboard");
      }, 800);
    } catch (err) {
      const msg =
        err?.response?.data?.message || "Failed to create workspace.";
      setError(msg);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-base-200 flex flex-col">
      <NavBar />

      <main className="flex-1">
        <div className="max-w-xl mx-auto px-4 py-6">
          <h1 className="text-2xl font-bold mb-2">Create Workspace</h1>
          <p className="text-sm text-neutral-500 mb-4">
            Enter a name, description, and the emails of members you want to
            invite.
          </p>

          {error && (
            <div className="alert alert-error py-2 text-sm mb-3">
              <span>{error}</span>
            </div>
          )}
          {message && (
            <div className="alert alert-success py-2 text-sm mb-3">
              <span>{message}</span>
            </div>
          )}

          <div className="card bg-base-100 shadow-md">
            <div className="card-body">
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="label">
                    <span className="label-text font-semibold">Name</span>
                  </label>
                  <input
                    type="text"
                    className="input input-bordered w-full"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    required
                    placeholder="Team Design Board"
                  />
                </div>

                <div>
                  <label className="label">
                    <span className="label-text font-semibold">
                      Description
                    </span>
                  </label>
                  <textarea
                    className="textarea textarea-bordered w-full"
                    rows={3}
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    placeholder="Short description of this workspace..."
                  />
                </div>

                <div>
                  <label className="label">
                    <span className="label-text font-semibold">
                      Member emails
                    </span>
                  </label>
                  <textarea
                    className="textarea textarea-bordered w-full"
                    rows={3}
                    value={memberEmailsText}
                    onChange={(e) => setMemberEmailsText(e.target.value)}
                    placeholder="example1@mail.com, example2@mail.com"
                  />
                  <p className="text-xs text-neutral-500 mt-1">
                    Separate emails with commas. Invitations are only sent to
                    users who already registered in the system.
                  </p>
                </div>

                <div className="pt-2">
                  <button
                    type="submit"
                    className={`btn btn-primary w-full ${
                      loading ? "btn-disabled" : ""
                    }`}
                    disabled={loading}
                  >
                    {loading ? "Creating..." : "Create workspace"}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </main>
    </div>
  );
}

export default CreateWorkspacePage;


===== FILE: frontend\src\pages\DashboardPage.jsx =====
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { getUser, isLoggedIn, clearAuth } from "../lib/auth";
import NavBar from "../components/NavBar";
import api from "../lib/api";

function DashboardPage() {
  const navigate = useNavigate();
  const user = getUser();

  const [workspaces, setWorkspaces] = useState([]);
  const [loadingWorkspaces, setLoadingWorkspaces] = useState(true);
  const [error, setError] = useState("");

  // If not logged in, redirect to login
  useEffect(() => {
    if (!isLoggedIn()) {
      navigate("/login");
    }
  }, [navigate]);

  useEffect(() => {
    const fetchWorkspaces = async () => {
      const token = localStorage.getItem("token");
      if (!token) {
        setLoadingWorkspaces(false);
        return;
      }

      setError("");
      setLoadingWorkspaces(true);
      try {
        const res = await api.get("/workspaces/my", {
          headers: { Authorization: `Bearer ${token}` },
        });
        setWorkspaces(Array.isArray(res.data) ? res.data : []);
      } catch (err) {
        setError("Failed to load workspaces.");
      } finally {
        setLoadingWorkspaces(false);
      }
    };

    fetchWorkspaces();
  }, []);

  const handleLogout = () => {
    clearAuth();
    navigate("/login");
  };

  return (
    <div className="min-h-screen bg-base-200 flex flex-col">
      <NavBar />

      <main className="flex-1">
        <div className="max-w-6xl mx-auto px-4 py-6">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h1 className="text-2xl font-bold">Dashboard</h1>
              <p className="text-sm text-neutral-500">
                {user
                  ? `Logged in as ${user.name} (${user.email})`
                  : "Loading user..."}
              </p>
            </div>

            <button onClick={handleLogout} className="btn btn-ghost btn-sm">
              Logout
            </button>
          </div>

          {error && (
            <div className="alert alert-error mb-4 py-2 text-sm">
              <span>{error}</span>
            </div>
          )}

          <section>
            <h2 className="text-lg font-semibold mb-3">My Workspaces</h2>

            {loadingWorkspaces ? (
              <div className="rounded-box border border-base-300 p-6 bg-base-100 text-sm text-neutral-500">
                Loading workspaces...
              </div>
            ) : workspaces.length === 0 ? (
              <div className="rounded-box border border-dashed border-base-300 p-6 text-center text-sm text-neutral-500 bg-base-100">
                No workspaces yet.
                <br />
                Use the{" "}
                <span className="font-semibold">Create workspace</span> button
                in the top right to add one later.
              </div>
            ) : (
              <div className="grid gap-4 md:grid-cols-2">
                {workspaces.map((ws) => (
                  <div
                    key={ws._id}
                    className="card bg-base-100 shadow-sm cursor-pointer hover:shadow-md transition"
                    onClick={() => navigate(`/workspaces/${ws._id}`)}
                  >
                    <div className="card-body">
                      <h3 className="card-title text-base">{ws.name}</h3>
                      {ws.description && (
                        <p className="text-sm text-neutral-600 line-clamp-2">
                          {ws.description}
                        </p>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </section>
        </div>
      </main>
    </div>
  );
}

export default DashboardPage;


===== FILE: frontend\src\pages\LoginPage.jsx =====
import { useState, useEffect } from "react";
import { useNavigate, Link } from "react-router-dom";
import api from "../lib/api";
import { saveAuth, isLoggedIn } from "../lib/auth";

function LoginPage() {
  const navigate = useNavigate();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");

  // If already logged in, go to dashboard
  useEffect(() => {
    if (isLoggedIn()) {
      navigate("/dashboard");
    }
  }, [navigate]);

  const handleLogin = async (e) => {
    e.preventDefault();
    setError("");

    try {
      const res = await api.post("/auth/login", { email, password });

      saveAuth(res.data.token, res.data.user);

      // Go to dashboard
      navigate("/dashboard");
    } catch (err) {
      setError("Login failed. Check email or password.");
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="card w-full max-w-sm bg-base-100 shadow-xl">
        <div className="card-body">
          <h2 className="card-title justify-center mb-4">Login</h2>

          {error && (
            <div className="alert alert-error py-1 text-sm mb-2">
              <span>{error}</span>
            </div>
          )}

          <form onSubmit={handleLogin} className="space-y-3">
            <div className="form-control">
              <label className="label">
                <span className="label-text">Email</span>
              </label>
              <input
                type="email"
                className="input input-bordered"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
                placeholder="you@example.com"
              />
            </div>

            <div className="form-control">
              <label className="label">
                <span className="label-text">Password</span>
              </label>
              <input
                type="password"
                className="input input-bordered"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
                placeholder="••••••••"
              />
            </div>

            <button type="submit" className="btn btn-primary w-full mt-2">
              Login
            </button>
          </form>

          <p className="text-center text-sm mt-4">
            New here?{" "}
            <Link to="/register" className="link link-primary">
              Register
            </Link>
          </p>
        </div>
      </div>
    </div>
  );
}

export default LoginPage;


===== FILE: frontend\src\pages\NotificationsPage.jsx =====
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import NavBar from "../components/NavBar";
import api from "../lib/api";
import { isLoggedIn } from "../lib/auth";

function NotificationsPage() {
  const navigate = useNavigate();

  const [invitations, setInvitations] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [message, setMessage] = useState("");

  useEffect(() => {
    const token = localStorage.getItem("token");
    if (!isLoggedIn() || !token) {
      navigate("/login");
      return;
    }

    const fetchInvites = async () => {
      setError("");
      setLoading(true);
      try {
        const res = await api.get("/invitations/my", {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });
        setInvitations(Array.isArray(res.data) ? res.data : []);
      } catch (err) {
        const msg =
          err?.response?.data?.message || "Failed to load invitations.";
        setError(msg);
      } finally {
        setLoading(false);
      }
    };

    fetchInvites();
  }, [navigate]);

  const handleAction = async (id, action) => {
    setError("");
    setMessage("");

    const token = localStorage.getItem("token");
    if (!token) {
      setError("Not authenticated.");
      return;
    }

    try {
      await api.post(
        `/invitations/${id}/${action}`,
        {},
        {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );

      setMessage(
        action === "accept"
          ? "Invitation accepted."
          : "Invitation rejected."
      );

      // Remove from list
      setInvitations((prev) => prev.filter((inv) => inv._id !== id));
    } catch (err) {
      const msg =
        err?.response?.data?.message || "Failed to update invitation.";
      setError(msg);
    }
  };

  return (
    <div className="min-h-screen bg-base-200 flex flex-col">
      <NavBar />

      <main className="flex-1">
        <div className="max-w-3xl mx-auto px-4 py-6">
          <h1 className="text-2xl font-bold mb-2">Notifications</h1>
          <p className="text-sm text-neutral-500 mb-4">
            Here you can accept or reject workspace invitations.
          </p>

          {error && (
            <div className="alert alert-error py-2 text-sm mb-3">
              <span>{error}</span>
            </div>
          )}
          {message && (
            <div className="alert alert-success py-2 text-sm mb-3">
              <span>{message}</span>
            </div>
          )}

          {loading ? (
            <div className="rounded-box border border-base-300 p-6 bg-base-100 text-sm text-neutral-500">
              Loading invitations...
            </div>
          ) : invitations.length === 0 ? (
            <div className="rounded-box border border-base-300 p-6 bg-base-100 text-sm text-neutral-500">
              You have no pending invitations.
            </div>
          ) : (
            <div className="space-y-3">
              {invitations.map((inv) => (
                <div
                  key={inv._id}
                  className="card bg-base-100 shadow-sm border border-base-200"
                >
                  <div className="card-body">
                    <h2 className="card-title text-base mb-1">
                      Workspace: {inv.workspace?.name || "Unknown"}
                    </h2>
                    <p className="text-sm text-neutral-600 mb-2">
                      Invited by{" "}
                      <span className="font-medium">
                        {inv.invitedBy?.name || "Someone"}
                      </span>{" "}
                      ({inv.invitedBy?.email || "no email"})
                    </p>

                    <div className="flex gap-2">
                      <button
                        className="btn btn-sm btn-primary"
                        onClick={() => handleAction(inv._id, "accept")}
                      >
                        Accept
                      </button>
                      <button
                        className="btn btn-sm btn-ghost"
                        onClick={() => handleAction(inv._id, "reject")}
                      >
                        Reject
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </main>
    </div>
  );
}

export default NotificationsPage;


===== FILE: frontend\src\pages\ProfilePage.jsx =====
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import NavBar from "../components/NavBar";
import api from "../lib/api";
import { getUser, isLoggedIn, saveAuth, clearAuth } from "../lib/auth";

function ProfilePage() {
  const navigate = useNavigate();
  const storedUser = getUser();

  const [name, setName] = useState(storedUser?.name || "");
  const [email, setEmail] = useState(storedUser?.email || "");
  const [message, setMessage] = useState("");
  const [error, setError] = useState("");

  // Redirect if not logged in
  useEffect(() => {
    if (!isLoggedIn()) {
      navigate("/login");
    }
  }, [navigate]);

  const handleLogout = () => {
    clearAuth();
    navigate("/login");
  };

  const handleUpdate = async (e) => {
    e.preventDefault();
    setError("");
    setMessage("");

    try {
      const token = localStorage.getItem("token");
      if (!token) {
        setError("Not authenticated.");
        return;
      }

      const res = await api.put(
        "/auth/me",
        { name, email },
        {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );

      // Update localStorage user with new data
      saveAuth(token, res.data.user);
      setMessage("Profile updated successfully.");
    } catch (err) {
      const msg =
        err?.response?.data?.message || "Failed to update profile.";
      setError(msg);
    }
  };

  const idText = storedUser?.id || "N/A";

  return (
    <div className="min-h-screen bg-base-200 flex flex-col">
      <NavBar />

      <main className="flex-1">
        <div className="max-w-3xl mx-auto px-4 py-6">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h1 className="text-2xl font-bold">Profile</h1>
              <p className="text-sm text-neutral-500">
                View and update your account details.
              </p>
            </div>

            <button
              onClick={handleLogout}
              className="btn btn-ghost btn-sm"
            >
              Logout
            </button>
          </div>

          <div className="card bg-base-100 shadow-xl">
            <div className="card-body">
              {error && (
                <div className="alert alert-error py-2 text-sm mb-2">
                  <span>{error}</span>
                </div>
              )}
              {message && (
                <div className="alert alert-success py-2 text-sm mb-2">
                  <span>{message}</span>
                </div>
              )}

              <form onSubmit={handleUpdate} className="space-y-4">
                <div>
                  <label className="label">
                    <span className="label-text font-semibold">
                      User ID
                    </span>
                  </label>
                  <input
                    type="text"
                    value={idText}
                    disabled
                    className="input input-bordered w-full bg-base-200"
                  />
                </div>

                <div>
                  <label className="label">
                    <span className="label-text font-semibold">
                      Name
                    </span>
                  </label>
                  <input
                    type="text"
                    className="input input-bordered w-full"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    required
                  />
                </div>

                <div>
                  <label className="label">
                    <span className="label-text font-semibold">
                      Email
                    </span>
                  </label>
                  <input
                    type="email"
                    className="input input-bordered w-full"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    required
                  />
                </div>

                <div className="pt-2">
                  <button type="submit" className="btn btn-primary">
                    Save changes
                  </button>
                </div>
              </form>
            </div>
          </div>

        </div>
      </main>
    </div>
  );
}

export default ProfilePage;


===== FILE: frontend\src\pages\RegisterPage.jsx =====
import { useState } from "react";
import { useNavigate, Link } from "react-router-dom";
import api from "../lib/api";

function RegisterPage() {
  const navigate = useNavigate();
  const [name, setName] = useState("");
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");

  const handleRegister = async (e) => {
    e.preventDefault();
    setError("");

    try {
      await api.post("/auth/register", { name, email, password });
      // After register, go to login
      navigate("/login");
    } catch (err) {
      setError("Registration failed. Try another email.");
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="card w-full max-w-sm bg-base-100 shadow-xl">
        <div className="card-body">
          <h2 className="card-title justify-center mb-4">Register</h2>

          {error && (
            <div className="alert alert-error py-1 text-sm mb-2">
              <span>{error}</span>
            </div>
          )}

          <form onSubmit={handleRegister} className="space-y-3">
            <div className="form-control">
              <label className="label">
                <span className="label-text">Name</span>
              </label>
              <input
                type="text"
                className="input input-bordered"
                value={name}
                onChange={(e) => setName(e.target.value)}
                required
                placeholder="Your name"
              />
            </div>

            <div className="form-control">
              <label className="label">
                <span className="label-text">Email</span>
              </label>
              <input
                type="email"
                className="input input-bordered"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
                placeholder="you@example.com"
              />
            </div>

            <div className="form-control">
              <label className="label">
                <span className="label-text">Password</span>
              </label>
              <input
                type="password"
                className="input input-bordered"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
                placeholder="••••••••"
              />
            </div>

            <button type="submit" className="btn btn-primary w-full mt-2">
              Register
            </button>
          </form>

          <p className="text-center text-sm mt-4">
            Already have an account?{" "}
            <Link to="/login" className="link link-primary">
              Back to Login
            </Link>
          </p>
        </div>
      </div>
    </div>
  );
}

export default RegisterPage;


===== FILE: frontend\src\pages\WorkspaceDetailsPage.jsx =====
import { useEffect, useState } from "react";
import { useNavigate, useParams } from "react-router-dom";
import NavBar from "../components/NavBar";
import api from "../lib/api";
import { isLoggedIn, getUser } from "../lib/auth";

function WorkspaceDetailsPage() {
  const { id } = useParams();
  const navigate = useNavigate();

  const currentUser = getUser();

  const [workspace, setWorkspace] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  const [inviteEmailsText, setInviteEmailsText] = useState("");
  const [inviteMessage, setInviteMessage] = useState("");
  const [inviteError, setInviteError] = useState("");
  const [inviteLoading, setInviteLoading] = useState(false);

  const [actionMessage, setActionMessage] = useState("");
  const [actionError, setActionError] = useState("");

  const token = typeof window !== "undefined"
    ? localStorage.getItem("token")
    : null;

  const loadWorkspace = async () => {
    if (!token) return;
    setError("");
    setLoading(true);
    try {
      const res = await api.get(`/workspaces/${id}`, {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
      setWorkspace(res.data);
    } catch (err) {
      const msg =
        err?.response?.data?.message || "Failed to load workspace.";
      setError(msg);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (!isLoggedIn() || !token) {
      navigate("/login");
      return;
    }
    loadWorkspace();
  }, [id, navigate]);

  const isOwner =
    workspace &&
    workspace.owner &&
    currentUser &&
    workspace.owner._id === currentUser.id;

  const handleInvite = async (e) => {
    e.preventDefault();
    setInviteError("");
    setInviteMessage("");

    if (!inviteEmailsText.trim()) {
      setInviteError("Please enter at least one email.");
      return;
    }

    const memberEmails = inviteEmailsText
      .split(",")
      .map((x) => x.trim())
      .filter((x) => x.length > 0);

    if (memberEmails.length === 0) {
      setInviteError("Please enter valid email(s).");
      return;
    }

    if (!token) {
      setInviteError("Not authenticated.");
      return;
    }

    setInviteLoading(true);
    try {
      const res = await api.post(
        `/workspaces/${id}/invite`,
        { memberEmails },
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );
      setInviteMessage(res.data.message || "Invitations sent.");
      setInviteEmailsText("");
    } catch (err) {
      const msg =
        err?.response?.data?.message || "Failed to send invitations.";
      setInviteError(msg);
    } finally {
      setInviteLoading(false);
    }
  };

  const handleRoleChange = async (memberId, newRole) => {
    setActionError("");
    setActionMessage("");

    if (!token) {
      setActionError("Not authenticated.");
      return;
    }

    try {
      await api.patch(
        `/workspaces/${id}/members/${memberId}/role`,
        { role: newRole },
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );
      setActionMessage("Member role updated.");
      await loadWorkspace();
    } catch (err) {
      const msg =
        err?.response?.data?.message || "Failed to update member role.";
      setActionError(msg);
    }
  };

  const handleRemoveMember = async (memberId) => {
    setActionError("");
    setActionMessage("");

    if (!window.confirm("Remove this member from the workspace?")) return;

    if (!token) {
      setActionError("Not authenticated.");
      return;
    }

    try {
      await api.delete(`/workspaces/${id}/members/${memberId}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      setActionMessage("Member removed from workspace.");
      await loadWorkspace();
    } catch (err) {
      const msg =
        err?.response?.data?.message || "Failed to remove member.";
      setActionError(msg);
    }
  };

  const renderStatusDot = (isOnline) => (
    <span
      className={`inline-block w-2 h-2 rounded-full mr-2 ${
        isOnline ? "bg-green-500" : "bg-red-500"
      }`}
    />
  );

  return (
    <div className="min-h-screen bg-base-200 flex flex-col">
      <NavBar />

      <main className="flex-1">
        <div className="max-w-4xl mx-auto px-4 py-6">
          {loading ? (
            <div className="rounded-box border border-base-300 p-6 bg-base-100 text-sm text-neutral-500">
              Loading workspace...
            </div>
          ) : error ? (
            <div className="alert alert-error py-2 text-sm">
              <span>{error}</span>
            </div>
          ) : !workspace ? (
            <div className="rounded-box border border-base-300 p-6 bg-base-100 text-sm text-neutral-500">
              Workspace not found.
            </div>
          ) : (
            <>
              <div className="mb-6">
                <h1 className="text-2xl font-bold mb-1">{workspace.name}</h1>
                {workspace.description && (
                  <p className="text-sm text-neutral-600">
                    {workspace.description}
                  </p>
                )}
              </div>

              {(actionError || actionMessage) && (
                <div className="mb-4 space-y-2">
                  {actionError && (
                    <div className="alert alert-error py-2 text-sm">
                      <span>{actionError}</span>
                    </div>
                  )}
                  {actionMessage && (
                    <div className="alert alert-success py-2 text-sm">
                      <span>{actionMessage}</span>
                    </div>
                  )}
                </div>
              )}

              <div className="grid gap-6 md:grid-cols-2">
                {/* Members */}
                <div className="card bg-base-100 shadow-md">
                  <div className="card-body">
                    <h2 className="card-title text-base mb-2">
                      Workspace Members
                    </h2>
                    <ul className="space-y-3 text-sm">
                      {workspace.members && workspace.members.length > 0 ? (
                        workspace.members.map((m) => {
                          const isCurrentUser =
                            currentUser &&
                            m._id === currentUser.id;

                          return (
                            <li
                              key={m._id}
                              className="flex flex-col border-b border-base-200 pb-2 last:border-0"
                            >
                              <div className="flex items-center justify-between">
                                <div className="flex items-center">
                                  {renderStatusDot(m.isOnline)}
                                  <div>
                                    <div className="font-medium">
                                      {m.name}
                                      {isCurrentUser && (
                                        <span className="text-xs text-neutral-500 ml-1">
                                          (you)
                                        </span>
                                      )}
                                    </div>
                                    <div className="text-xs text-neutral-500">
                                      {m.email}
                                    </div>
                                  </div>
                                </div>

                                <div className="flex items-center gap-2">
                                  {isOwner ? (
                                    <select
                                      className="select select-xs select-bordered"
                                      value={m.role}
                                      disabled={isCurrentUser && m.role === "owner"}
                                      onChange={(e) =>
                                        handleRoleChange(m._id, e.target.value)
                                      }
                                    >
                                      <option value="owner">Owner</option>
                                      <option value="editor">Editor</option>
                                      <option value="viewer">Viewer</option>
                                    </select>
                                  ) : (
                                    <span className="badge badge-outline">
                                      {m.role}
                                    </span>
                                  )}

                                  {isOwner &&
                                    !(m.role === "owner" && isCurrentUser) && (
                                      <button
                                        className="btn btn-xs btn-ghost"
                                        onClick={() =>
                                          handleRemoveMember(m._id)
                                        }
                                      >
                                        Remove
                                      </button>
                                    )}
                                </div>
                              </div>
                            </li>
                          );
                        })
                      ) : (
                        <li className="text-neutral-500 text-sm">
                          No members yet.
                        </li>
                      )}
                    </ul>
                  </div>
                </div>

                <div className="space-y-4">
                  <div className="card bg-base-100 shadow-md">
                    <div className="card-body">
                      <h2 className="card-title text-base mb-2">
                        Workspace Owner
                      </h2>
                      {workspace.owner ? (
                        <div className="flex items-center gap-2 text-sm">
                          {renderStatusDot(workspace.owner.isOnline)}
                          <div>
                            <div className="font-medium">
                              {workspace.owner.name}
                              {currentUser &&
                                workspace.owner._id === currentUser.id && (
                                  <span className="text-xs text-neutral-500 ml-1">
                                    (you)
                                  </span>
                                )}
                            </div>
                            <div className="text-xs text-neutral-500">
                              {workspace.owner.email}
                            </div>
                          </div>
                        </div>
                      ) : (
                        <p className="text-sm text-neutral-500">
                          Owner information not available.
                        </p>
                      )}
                    </div>
                  </div>

                  {isOwner && (
                    <div className="card bg-base-100 shadow-md">
                      <div className="card-body">
                        <h2 className="card-title text-base mb-2">
                          Invite Members
                        </h2>
                        {inviteError && (
                          <div className="alert alert-error py-2 text-xs mb-2">
                            <span>{inviteError}</span>
                          </div>
                        )}
                        {inviteMessage && (
                          <div className="alert alert-success py-2 text-xs mb-2">
                            <span>{inviteMessage}</span>
                          </div>
                        )}
                        <form onSubmit={handleInvite} className="space-y-2">
                          <textarea
                            className="textarea textarea-bordered w-full text-sm"
                            rows={3}
                            value={inviteEmailsText}
                            onChange={(e) =>
                              setInviteEmailsText(e.target.value)
                            }
                            placeholder="example1@mail.com, example2@mail.com"
                          />
                          <p className="text-xs text-neutral-500">
                            Separate emails with commas. Invitations are only
                            sent to users who already registered.
                          </p>
                          <button
                            type="submit"
                            className={`btn btn-primary btn-sm ${
                              inviteLoading ? "btn-disabled" : ""
                            }`}
                            disabled={inviteLoading}
                          >
                            {inviteLoading ? "Sending..." : "Invite members"}
                          </button>
                        </form>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </>
          )}
        </div>
      </main>
    </div>
  );
}

export default WorkspaceDetailsPage;

